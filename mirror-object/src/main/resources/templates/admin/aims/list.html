<!DOCTYPE html>
<html lang="zh-cmn-Hans" xmlns:th="http://www.thymeleaf.org">
<head th:include="admin/include/head"></head>
<meta http-equiv="Content-Type" content="multipart/form-data;charset=utf-8"/>
<link rel="stylesheet" th:href="@{/plugins/datetimppicker/bootstrap-datetimepicker.min.css}"/>
<link rel="stylesheet" th:href="@{/plugins/fileinput/css/fileinput.css}"/>
<style>
    .table-box {
        padding: 10px;
    }

    .img {
        width: 100%;
    }

    .time {
        font-size: 12px;
        padding-left: 5px;
        padding-top: 3px;
        padding-bottom: 3px;
        color: #524e4e;
    }

    .img-box {
        margin-top: 10px;
    }

    .preview_img {
        width: 220px;
        height: auto;
        border: 1px solid #cecece;
        border-radius: 5px;
        box-shadow: 1px 1px 2px 1px #cecece;
        margin-bottom: 20px;
    }

    .img-show-box {
        border: 1px solid #cecece;
        border-radius: 5px;
        box-shadow: 1px 1px 2px 1px #cecece;
        margin-bottom: 20px;
    }

    #kk{
        width:400px;
        height:400px;
        overflow: hidden;
    }
    #preview_wrapper{
        width:300px;
        height:300px;
        background-color:#CCC;
        overflow: hidden;
    }
    #preview_fake{ /* 该对象用于在IE下显示预览图片 */
        filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale);
        width:300px;
        overflow: hidden;
    }
    #preview_size_fake{ /* 该对象只用来在IE下获得图片的原始尺寸，无其它用途 */
        filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=image);
        width:300px;
        visibility:hidden;
        overflow: hidden;
    }
    #preview{ /* 该对象用于在FF下显示预览图片 */
        width:300px;
        height:300px;
        overflow: hidden;
    }
</style>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

    <div th:include="admin/include/layout" th:remove="tag"></div>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div th:include="admin/include/title" th:remove="tag"></div>

        <!-- Main content -->
        <section class="content">
            <div class="col-md-3">
                <div class="box">
                    <div id="area_tree"></div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="box table-box">
                    <div class="form-group pull-left">
                        <form id="uploadForm">
                            <!--<input id="img_input" type="file" name="file" accept="image/*" />-->
                            <!--<label for="img_input" class="btn btn-primary btn-add">上传</label>-->
                            <input name="localfile"  type="file" id="localfile" size="28" onchange="onUploadImgChange(this)"/>
                        </form>
                    </div>
                    <div class="form-inline pull-right">
                        <div class="form-group">
                            <label for="minSimilarity">相似度</label>
                            <input id="minSimilarity" type="text" class="form-control" style="width: 50px">
                        </div>
                        <div class="form-group">
                            <label for="maxSimilarity">—</label>
                            <input id="maxSimilarity" type="text" class="form-control" style="width: 50px">
                        </div>
                        <div class="form-group">
                            <label for="searchStart">开始时间</label>
                            <input id="searchStart" size="16" type="text" readonly class="form-control form_datetime"
                                   style="width: 150px">
                        </div>
                        <div class="form-group">
                            <label for="searchEnd">结束时间</label>
                            <input id="searchEnd" size="16" type="text" readonly class="form-control form_datetime"
                                   style="width: 150px">
                        </div>
                        <button type="submit" class="btn btn-default btn-search">搜索</button>
                    </div>
                    <div class="clearfix"></div>
                    <div class="col-md-4 col-md-offset-5 img-box">
                        <!--<img id="preview_img" class="preview_img" style="display: none;"/>-->

                        <div id="kk">
                            <div id="preview_wrapper">
                                <div id="preview_fake">
                                    <img id="preview" src="" onload="onPreviewLoad(this)"/>
                                </div>
                            </div>
                            <br/>
                            <img id="preview_size_fake" />
                        </div>
                    </div>
                    <table class="box-body col-md-12" id="target_list"></table>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:include="admin/include/copyright" th:remove="tag"></div>
</div>
<!-- ./wrapper -->
<div th:include="admin/include/footer" th:remove="tag"></div>
<script th:src="@{/plugins/datetimppicker/bootstrap-datetimepicker.min.js}"></script>
<script th:src="@{/plugins/datetimppicker/bootstrap-datetimepicker.zh-CN.js}"></script>
<script th:src="@{/plugins/fileinput/js/fileinput.js}"></script>
<script th:inline="javascript">
    var accessUpdate = [[${user.hasAccessModuleAction('target', 'U')}]];
    var accessDelete = [[${user.hasAccessModuleAction('target', 'D')}]];

    var imgSrc;

    function onUploadImgChange(sender){
        if( !sender.value.match( /.jpg|.gif|.png|.bmp/i ) ){
            alert('图片格式无效！');
            return false;
        }
        var objPreview = document.getElementById('preview');
        var objPreviewFake = document.getElementById('preview_fake');
        var objPreviewSizeFake = document.getElementById('preview_size_fake');
        if( sender.files &&  sender.files[0] ){
            objPreview.style.display = 'block';
            objPreview.style.width = 'auto';
            objPreview.style.height = 'auto';

            // Firefox 因安全性问题已无法直接通过 input[file].value 获取完整的文件路径
            objPreview.src = sender.files[0].getAsDataURL();

            imgSrc = sender.files[0].getAsDataURL();
        }else if( objPreviewFake.filters ){
            // IE7,IE8 在设置本地图片地址为 img.src 时出现莫名其妙的后果
            //（相同环境有时能显示，有时不显示），因此只能用滤镜来解决

            // IE7, IE8因安全性问题已无法直接通过 input[file].value 获取完整的文件路径
            sender.select();
            sender.blur();
            imgSrc = document.selection.createRange().text;
            objPreviewFake.filters.item('DXImageTransform.Microsoft.AlphaImageLoader').src = imgSrc;
            objPreviewSizeFake.filters.item('DXImageTransform.Microsoft.AlphaImageLoader').src = imgSrc;
            autoSizePreview( objPreviewFake,objPreviewSizeFake.offsetWidth, objPreviewSizeFake.offsetHeight );
            objPreview.style.display = 'none';
        }

        $.ajax({
            url: 'aims/upload',
            type: 'POST',
            cache: false,
            data: $("#localfile").val(),
            contentType: 'application/x-www-form-urlencoded',
            success:function (res) {
                uploadId = res.data;
            },
            error:function (res) {
                toastr.warning("请求列表数据失败, 请重试");
            }
        });
    }

    function onPreviewLoad(sender){
        autoSizePreview( sender, sender.offsetWidth, sender.offsetHeight );
    }
    function autoSizePreview( objPre, originalWidth, originalHeight ){
        var zoomParam = clacImgZoomParam( 300, 300, originalWidth, originalHeight );
        objPre.style.width = zoomParam.width + 'px';
        objPre.style.height = zoomParam.height + 'px';
        objPre.style.marginTop = zoomParam.top + 'px';
        objPre.style.marginLeft = zoomParam.left + 'px';
    }
    function clacImgZoomParam( maxWidth, maxHeight, width, height ){
        var param = { width:width, height:height, top:0, left:0 };

        if( width>maxWidth || height>maxHeight ){
            rateWidth = width / maxWidth;
            rateHeight = height / maxHeight;

            if( rateWidth> rateHeight ){
                param.width =  maxWidth;
                param.height = height / rateWidth;
            }else{
                param.width = width / rateHeight;
                param.height = maxHeight;
            }
        }
        param.left = (maxWidth - param.width) / 2;
        param.top = (maxHeight - param.height) / 2;

        return param;
    }
</script>
<script th:src="@{/js/admin/aims/aims.js}"></script>

</body>
</html>
